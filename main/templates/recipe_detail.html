{% extends 'base.html' %}

{% load staticfiles %}
{% load crispy_forms_tags %}

{% block body %}

<div class="container">        
<div class="row"><!-- Name and Header--><div class="box">

<!-- /// #Name ////////////////////////////////////////////////// -->
    <div id="name-section"
         class="col-xs-12">

        <!-- Default View -->
        <div id="name-editable"
             class="attribute-editable">
            <h1 id="name-edit-target"
                >{{ recipe.name }}</h1>
        </div><!-- /#name-editable -->

        <!-- Edit View -->
        <div id="name-editing"
             class="attribute-editing hidden">
 
            <h4 id="name-edit-head"
                >Recipe Name (60 character max):</h4>
            <textarea id="name-edit-input"
                      class="attr-edit-input"
                      rows="1"
                      cols="70"
                      maxlength="60"
                      >{{ recipe.name }} </textarea> 
            <a id='name-save-btn'
               class='btn btn-primary attr-save-btn'
               role='button'>Save</a>
        </div><!-- /#name-editing -->

    </div><!-- /#name-section -->

<!-- /// #Header Left Side ////////////////////////////////////// -->
    <div id="header-left-side"
         class="col-lg-4
                col-md-4
                col-sm-4
                col-xs-12">

        {% if recipe.image %}
            <img id="image-display"
                 class="col-md-12"
                 src="{{ recipe.image.url }}"
                 alt="testing">
        {% else %}
            <img id="image-display"
                 class="col-md-12"
                 src="{% static 'img/food_default_300px.jpg' %}"
                 alt="Please Upload an Image of the Prepared Recipe">
        {% endif %}

    </div><!-- /#header-left-side -->

<!-- /// #Header Right Side ///////////////////////////////////// -->
    <div id="header-right-side"
         class="col-lg-8
                col-md-8
                col-sm-12
                col-xs-12">

        <div id="key-info-box">

    <!-- Time ............................................... -->
        <div id="time-info">
        <!-- Default View -->
            <div id="time-editable"
                 class="attribute-editable key-info-col"> 
                <span class="key-info-head">Time</span><br>
                <span id="time-default-data"
                      class="key-info-data"
                    ><span id="time-edit-target"
                    >{{ recipe.time_tot }}</span> mins</span>
            </div>

        <!-- Popup -->
            <div id="time-popup"
                 class="popup hidden">
                <table class="popup-table">
                    <tr>
                        <td align="right"><b>Total Time: </b></td>
                        <td><b>{{ energy_basic.energy_tot }} mins</b></td></tr>
                    <tr>
                        <td align="right">Prep: </td>
                        <td>{{ recipe.time_prep }} mins</td></tr>
                    <tr>
                        <td align="right">Cook: </td>
                        <td>{{ recipe.time_cook }} mins</td></tr>
                </table>
            </div>

        <!--- Edit View -->
            <div id="time-editing"
                 class="attribute-editing hidden">
                <span id="time-editing-head"
                      class="key-info-head"
                    >Prep Time + Cook Time = Total Time (mins):</span>
                <div id="time-editing-body">
                    <input id="time_prep-edit-input"
                              class="attr-edit-input"
                              maxlength="5"
                              value="{{ recipe.time_prep }}"></input> 
                    <span id="time-edit-plus"
                          class="time-edit-text"
                          >+</span>
                    <input id="time_cook-edit-input"
                              class="attr-edit-input"
                              maxlength="5"
                              value="{{ recipe.time_cook }}"></input>
                    <span id="time-edit-equals"
                          class="time-edit-text"
                          >=</span>
                    <span id="time_tot-edit-calc"
                          class="time-edit-text"
                          >{{ recipe.time_tot }}</span>
                    <a id='time-save-btn'
                       class='btn btn-primary attr-save-btn'
                       role='button'>Save</a>
                </div><!-- /#time-editing-body -->
            </div><!-- /#time-editing -->

        </div><!-- /#time-info -->

    <!-- Energy ............................................. -->
        <!-- Default View -->
            <div id="energy-info" class="attribute-editable key-info-col">
                <span class="key-info-head">Energy</span><br>
                <span id="energy-default-data"
                      class="key-info-data"
                    >{{ energy_basic.energy_tot }} Cal</span>

        <!-- Popup -->
                <div id="energy-popup"
                     class="popup hidden">
                    <table class="popup-table">
                        <tr><td align="right"><b>Total Energy: </b></td><td><b>{{ energy_basic.energy_tot }} Cal</b></td></tr>
                        <tr><td align="right">Carbs: </td><td>{{ energy_basic.energy_ptn }} Cal</td></tr>
                        <tr><td align="right">Protein: </td><td>{{ energy_basic.energy_ptn }} Cal</td></tr>
                        <tr><td align="right">Fat: </td><td>{{ energy_basic.energy_fat }} Cal</td></tr>
                    </table>
                </div>
            </div><!-- /#energy-info -->

    <!-- Rating ............................................. -->
            <div id="rating-info">

                <div id="stars-tot">
                    <span id="stars-total"></span>
                    <br>
                    <span id="stars-tot-data"
                        ><span id="raters-total"
                            >{{ rating_stat_v.count }}</span>
                        <span id="stars-tot-labels"
                            > ratings; avg: </span>
                        <span id="rating-total"
                            >{{ rating_stat_v.avg }}</span></span>
                </div>

                <div id="stars-use">
                    <span id="stars-user"></span>
                    <br>

                    <span id="hidden-rating-saved"
                          style="display: none;"
                    >{{ rating_v.rating }}</span>

                    {% if rating_v.rating == -1 %}
                        Sign-in to rate
                    {% elif rating_v.rating == 0 %}
                        Add your rating
                    {% else %}
                        <a id="rating-remove" href="#">Remove your rating</a>
                    {% endif %}

                </div>
            </div><!-- /#rating-info -->

    <!-- Description ........................................ -->
            <div id="description-info">

                <div id="key-info-description">
                    <!-- Default View -->
                    <div id="description-editable"
                         class="attribute-editable">
                        <span class="key-info-head"
                            >Description:</span><br>
                        <span class="meta-info-data"
                              id="description-edit-target"
                            >{{ recipe.description }}</span>
                    </div>

                    <!-- Edit View -->
                    <div id="description-editing"
                         class="attribute-editing hidden">
                        <span id="description-edit-head"
                              class="key-info-head"
                            >Description (100 character max):</span><br>
                        <textarea id="description-edit-input"
                                  class="attr-edit-input"
                                  rows="2"
                                  cols="35"
                                  maxlength="100"
                                  >{{ recipe.description }} </textarea> 
                        <a id='description-save-btn'
                           class='btn btn-primary attr-save-btn'
                           role='button'>Save</a><br>
                    </div>

                </div><!-- /#key-info-description -->

            </div><!-- /#description-info -->

        </div><!-- /#key-info-box -->

    <!-- Ingredients ............................................ -->
        <div id="ingredient-info">
            <div id="ingred-box">
        <!-- Ingred List Output 0 ................................... -->
                <span id="ingred-list-output-0"
                    ><h4>
                        Ingredients for 
                        <span id="servings-display"></span>
                        <span id="servings-change"></span>
                    </h4>

                    <div class="ingred-list">
                    {% for quant in recipe.quantity_set.all %}
                        <div id="ingred-{{ quant.ingred.ndb_id.ndb_no }}"
                              class="ingred-list-item"
                            ><span class="qty-common"
                            >{{ quant.qty_common }}</span>&nbsp;<span
                            >{{ quant.ingred.label }} </span><span
                            >{{ quant.name_common }} </span><br>
                        </div>
                    {% endfor %}
                    </div>
                
        <!-- Ingred List Output 1 ................................... -->
                <span id='ingred-list-output-1'></span>
                <br>

        <!-- Ingred List Output 2 ................................... -->
                <span id='ingred-list-output-2'
                    ><a id='ingred-add-btn'
                       class='btn btn-primary'
                       role='button'>Add Ingredient</a></span><br>

        <!-- Ingred List Output 3 ................................... -->
                <strong id='ingred-list-output-3'>
                </strong>

            </div><!-- /#ingred-box -->

            <div id="ingred-nutr-box">
            <!-- Right Side Head ........................................ -->
                <h4 id="right-side-head">
                    Nutrition per Serving:
                </h4>

            <!-- Right Side Body ........................................ -->
                <span id="right-side-body">
                <table id="nutr-table">
                    <tr><td align="right"><b>Calories: </b></td><td><b>{{ energy_basic.energy_tot }} Cal</b></td></tr>
                    <tr><td align="right">Carbs: </td><td>{{ energy_basic.energy_ptn }} Cal</td></tr>
                    <tr><td align="right">Protein: </td><td>{{ energy_basic.energy_ptn }} Cal</td></tr>
                    <tr><td align="right">Fat: </td><td>{{ energy_basic.energy_fat }} Cal</td></tr>
                    <tr class="blank-row"><td colspan="3"></td></tr>
                    <tr><td align="right"><b>Mass: </b></td><td><b>{{ mass_basic }} g</b></td></tr>
                    <tr><td align="right">Carbs: </td><td>{{ nutr_basic.carbs }} g</td></tr>
                    <tr><td align="right">Protein: </td><td>{{ nutr_basic.protein }} g</td></tr>
                    <tr><td align="right">Fat: </td><td>{{ nutr_basic.lipids }} g</td></tr>
                    <tr><td align="right">Fiber: </td><td>{{ nutr_basic.fiber }} g</td></tr>
                    <tr><td align="right">Sugars: </td><td>{{ nutr_basic.sugars }} g</td></tr>
                    <tr><td align="right">Water: </td><td>{{ nutr_basic.water }} g</td></tr>
                    <tr><td align="right">Sodium: </td><td>{{ nutr_other.sodium }} mg</td></tr>
                </table>
                </span>
            </div><!-- /#ingred-nutr-box -->

        </div><!-- /#ingredient-info -->
    </div><!-- /#header-right-side -->

<!-- /// #Header/Section Divider //////////////////////////////// -->
    {% comment %}<div id="header-section-divider">
        <hr class="col-xs-12">
    </div><!-- /#header-section-divide -->{% endcomment %}

</div><!-- /.box --></div><!-- /.row Name and Header -->

<div class="row"><div class="box">

<!-- /// #Left Side Section ///////////////////////////////////// -->
    <div id="left-side-section"
         class="col-lg-6
                col-md-6">
        
    <!-- Meta Info .............................................. -->
        {% comment %}<!--
        <div id="meta-info" class="col-xs-8">

            <div id="meta-info-tags">
                <p class="meta-info-spacer">
                <span class="meta-info-head">Tags:</span><br>
                <span class="meta-info-data">{{ recipe.tags }}</span>
                </p>
            </div><!-- /#meta-info-tags -->
            
            <div id="meta-info-source">
                <!-- Default View -->
                <div id="source-editable"
                     class="attribute-editable">
                    <p class="meta-info-spacer">
                        <span class="meta-info-head"
                            >Source:</span><br>
                        <span id="source-edit-target"
                              class="meta-info-data"
                            >{{ recipe.author }}</span>
                    </p>
                </div>

                <!-- Edit View -->
                <div id="source-editing"
                     class="attribute-editing hidden">
                    <span id="source-edit-head"
                          class="meta-info-head"
                        >Source (250 character max):</span><br>
                    <textarea id="source-edit-input"
                              class="attr-edit-input"
                              rows="3"
                              cols="35"
                              maxlength="50"
                              >{{ recipe.source }} </textarea> 
                    <a id='source-save-btn'
                       class='btn btn-primary attr-save-btn'
                       role='button'>Save</a><br>
                </div><!-- /#source-editing -->

            </div><!-- /#meta-info-source -->

        </div><!-- / Meta Info -->
        -->{% endcomment %}

    <!-- Edit, Delete, Add ...................................... -->
        <div id="edit-delete-add" class="col-xs-4" style="text-align: right">

            <a id="recipe-edit-btn"
               class="btn btn-primary crud-btn"
               role="button">Edit Recipe</a>

            <a id="recipe-delete-btn"
               class="btn btn-primary crud-btn"
               href="/recipe_delete_page/{{ recipe.pk }}"
               role="button">Delete Recipe</a>

            <a id="recipe-add-btn"
               class="btn btn-primary crud-btn"
               href="/recipe_create/"
               role="button">Add Recipe</a>

        </div><!-- /#edit-delete-add -->

    </div><!-- /#left-side-section -->

<!-- /// #Right Side Section //////////////////////////////////// -->
    <div id="right-side-section"
         class="col-lg-6
                col-md-6">
        
    </div><!-- /#right-side-section -->

<!-- /// Section/Bottom Divider ///////////////////////////////// -->
    <div>
        <hr class="col-xs-12">
    </div><!-- /Section Bottom Divider -->

</div><!-- /.box --></div><!-- /.row /Main Section-->

<div class="row"><div class="box">

<!-- /// #Bottom Left Side ///////////////////////////////////// -->

    <div id="bottom-left-side"
         class="col-lg-6
                col-md-6">

        <div id="directions-head">
            <h4>
                Directions:
            </h4>
        </div>

        <div id="directions-display">
            {{ recipe.directions }}
            <br>
        </div>

    </div><!-- /#bottom-left-side-->

<!-- /// #Bottom Right Side ///////////////////////////////////// -->
    <div id="bottom-right-side"
         class="col-lg-6
                col-md-6">

    <!-- Comments Display ....................................... -->
        <div id="comments-head">
            <h4>
                Comments:
            </h4>
        </div>

        <div id="comments-display">
            {% for comment in old_comments_v %}
                {{ comment.number }}. <br>
                {{ comment.text }}<br>
                Comment by 
                {{ comment.user_name }} --- 
                {{ comment.time_stamp }}<hr>
            {% endfor %}
        </div><!-- /#comments-display -->

    <!-- New Comments ........................................... -->
        <div id="new-comments">

            {% if active %}
                {% crispy comments_v %}
            {% else %}
                You must be signed-in to comment. Please 
                <a href="/sign_in/">sign in</a> 
                or 
                <a href="/sign_in/">create an account</a> 
                and sign in.
            {% endif %}

        </div><!-- /#new-comments -->

    </div><!-- /#bottom-right-side-->

<!-- /// #Bottom/Footer Divider ///////////////////////////////// -->
    <div>
        <hr class="col-xs-12">
    </div><!-- /Bottom Footer Divider -->

</div><!-- /.box --></div><!-- /.row /Bottom -->
</div><!-- /.container -->

<!-- /// Hidden Data //////////////////////////////////////////// -->
    <span id="hidden-servings-orig"
          style="display: none;"
          >{{ recipe.servings_orig }}</span>

<!-- /// Javascript ///////////////////////////////////////////// -->
<script src="{% static 'js/jquery.js' %}"></script>

<script src="{% static 'js/js.cookie.js' %}"></script>

<script type="text/javascript">

    // Set the source of the rating-star images
    var starGray = "/static/img/star_gray_100px.png ";
    var starMagenta = "/static/img/star_magenta_100px.png ";

    // On loading, apply any scaling of the recipe to the ingredient quantities
    $(function() {

        var servOrig = $('#hidden-servings-orig').text()
        var servModifCookie = Cookies.get("servModifCookie")

        if(servModifCookie) {
            servTemp = servModifCookie
        } else {
            servTemp = servOrig
        };

        if(servTemp == 1) {
            servTempStr = "1 serving: "
        } else {
            servTempStr = servTemp + " servings: "
        }

        $('#servings-display').text('').append(
            servTempStr
        );
        $('#servings-change').text('').append(
            "<a id='servings-scale-btn'" +
               "class='btn btn-primary'" +
               "href='#'" +
               "role='button'>Change" +
            "</a>"
        );
        servingsScale(servTemp);

        var numIngreds = $('.qty-common').length
        for(i = 0; i < numIngreds; i++) {
            qtyComm = Number($('.qty-common')[i].innerText)
            qtyDisplay = qtyComm * servTemp
            
            // Deal with long floats
            length = qtyDisplay.toString().length
            decimal = qtyDisplay.toString().indexOf('.')

            if(length - decimal > 2) {
                temp = qtyDisplay.toFixed(2);
                lastTwo = temp.toString().slice(-2)
                if (lastTwo == '00') {
                    qtyDisplay = qtyDisplay.toFixed(0);
                } else if (lastTwo == '25') {
                    qtyDisplay = qtyDisplay.toFixed(2);
                } else {
                    qtyDisplay = qtyDisplay.toFixed(1);
                };
            };

            $('.qty-common')[i].innerText = qtyDisplay
        };

        // Rating of Recipes
        var ratersTotal = $('#raters-total').text();
        var ratingTotal = $('#rating-total').text();
        var ratingSaved = $('#hidden-rating-saved').text();

        var starSourceC = [starGray, starGray, starGray, starGray, starGray];
        var starSourceU = [starGray, starGray, starGray, starGray, starGray];

        for (i = 0; i < Math.floor(ratingTotal); i++) {
            starSourceC[i] = starMagenta;
        };

        $('#stars-total').text('').append(
            "<img class='star-crowd'" +
                 "id='star-c-1'" +
                 "src=" + starSourceC[0] + ">" +
            "<img class='star-crowd'" +
                 "id='star-c-2'" +
                 "src=" + starSourceC[1] + ">" +
            "<img class='star-crowd'" +
                 "id='star-c-3'" +
                 "src=" + starSourceC[2] + ">" +
            "<img class='star-crowd'" +
                 "id='star-c-4'" +
                 "src=" + starSourceC[3] + ">" +
            "<img class='star-crowd'" +
                 "id='star-c-5'" +
                 "src=" + starSourceC[4] + ">"
        );

        for (i = 0; i < ratingSaved; i++) {
            starSourceU[i] = starMagenta;
        };

        $('#stars-user').text('').append(
            "<img class='star-user' id='star-u-1'" +
                 "src=" + starSourceU[0] + ">" +
            "<img class='star-user' id='star-u-2'" +
                 "src=" + starSourceU[1] + ">" +
            "<img class='star-user' id='star-u-3'" +
                 "src=" + starSourceU[2] + ">" +
            "<img class='star-user' id='star-u-4'" +
                 "src=" + starSourceU[3] + ">" +
            "<img class='star-user' id='star-u-5'" +
                 "src=" + starSourceU[4] + ">"
        );
        ratingMouseOver(ratingSaved);
    });

    // Time info popup
    $('#time-info').on('mouseover', function() {
        console.log("time-info mouseover");
        $('#time-popup').removeClass('hidden');
        $('#time-default-data').addClass('hidden');
    });

    $('#time-info').on('mouseout', function() {
        $('#time-popup').addClass('hidden');
        $('#time-default-data').removeClass('hidden');
    });

    // Energy info popup
    $('#energy-info').on('mouseover', function() {
        console.log("energy-info mouseover");
        $('#energy-popup').removeClass('hidden');
        $('#energy-default-data').addClass('hidden');
    });

    $('#energy-info').on('mouseout', function() {
        $('#energy-popup').addClass('hidden');
        $('#energy-default-data').removeClass('hidden');
    });

    // Edit an Attribute in the Name or Header ----------------------
    $('#recipe-edit-btn').on('click', function() {
        console.log("edit btn")

        $('.attribute-editable').addClass('hidden');
        $('.attribute-editing').removeClass('hidden');
        $('#name-edit-input').focus();

        $('#time_prep-edit-input').on('keyup', function() {
            timeTotCalc();
        });
        $('#time_cook-edit-input').on('keyup', function() {
            timeTotCalc();
        });

        var timeTotCalc = function() {
            timePrep = Number($('#time_prep-edit-input').val());
            timeCook = Number($('#time_cook-edit-input').val());
            $('#time_tot-edit-calc').text(timePrep + timeCook);
        };
    });

    // Click on item in ingredient list; get ndb_no
    $('.ingred-list-item').on('click', function() {
        var itemNdbNo = this.id.split(/[-]/)[1];
        console.log(itemNdbNo);
    });

    $('.ingred-list-item').on('mouseover', function() {
        var itemID = this.id;
        $('#' + itemID).addClass('ingred-list-highlight');

        // var itemNdbNo = itemID.split(/[-]/)[1];
        // console.log(itemNdbNo);
    });
        
    $('.ingred-list-item').on('mouseout', function() {
        var itemID = this.id;
        $('#' + itemID).removeClass('ingred-list-highlight');
    });


    // Click on the "Save" button for an edited attribute
    // Get the name of the attribute
    $('.attr-save-btn').on('click', function() {
        console.log("attr-save-btn clicked");
        
        var attribute = this.id.split(/[-]/)[0];
        console.log(attribute)

        // Handle the Time attributes
        if(attribute == "time") {
            timeValue(attribute);
        } else {
            attrValue(attribute);
        };
    });

    // Read edited attribute input values for a given attribute
    var attrValue = function(attribute) {
        var inputID = '#' + attribute + '-edit-input';
        console.log(inputID);
        var newValue = $(inputID).val();
        console.log(newValue);
        var pAttr = attribute;

        attrSave(pAttr, attribute, newValue)
    };

    // 
    var timeValue = function(attribute) {
        pAttr = attribute
        timePrep = Number($('#time_prep-edit-input').val());
        timeCook = Number($('#time_cook-edit-input').val());
        timeTot = timePrep + timeCook;
        console.log("timeTot: " + timeTot);

        attrSave(pAttr, 'time_prep', timePrep);
        attrSave(pAttr, 'time_cook', timeCook);
        attrSave(pAttr, 'time_tot', timeTot);
    };

    // Accept and save edited value for given attribute; pAttr
    // (parent attribute) deals with multi-value cases like "time"
    var attrSave = function(pAttr, attribute, newValue) {
        console.log("attrSave func initiated");

        $.ajax({
            type: 'GET',
            url: '/recipe_attr_edit_func/' + {{ recipe.pk }},
            data: { attr: attribute,
                    new_value: newValue,
                   },
            error: function() {},
            success: function() {
                console.log("attrSave func executed");

                $('#' + pAttr + '-editable').removeClass('hidden');
                $('#' + pAttr + '-editing').addClass('hidden');
                $('#' + pAttr + '-edit-target').text(newValue);
            }
        });
    };

    // Set up user rating by changing star colors as the mouse touches
    var ratingMouseOver = function(ratingSaved) {
        $('.star-user').on('mouseleave', function() {
            for (i = 1; i <= 5; i++) {
                if (i <= ratingSaved) {
                    $('#star-u-' + i).attr('src', starMagenta);
                } else {
                    $('#star-u-' + i).attr('src', starGray);
                };
            };
        });

        $('.star-user').on('mouseover', function() {
            var starNum = Number(this.id.slice(-1))
            // console.log(starNum);
            ratingTemp(starNum);
        });

        // Capture actual user rating when user clicks on a star
        $('.star-user').on('click', function() {
            var starNum = Number(this.id.slice(-1))
            console.log(starNum);
            ratingPerm(starNum);
        });

        // Remove user rating when user clicks on "remove your rating"
        $('#rating-remove').on('click', function() {
            var starNum = 0;
            console.log(starNum);
            ratingPerm(starNum);
        });
    };

    var ratingTemp = function(starNum) {
        for (i = 1; i <= 5; i++) {
            if (i <= starNum) {
                $('#star-u-' + i).attr('src', starMagenta);
            } else {
                $('#star-u-' + i).attr('src', starGray);
            };
        };
    };

    var ratingPerm = function(starNum) {

        $.ajax({
            type: 'GET',
            url: '/rating_func/' + {{ recipe.pk }},
            data: { rating_new: starNum },
            error: function() {},
            success: function() {
                console.log("rating_func success")
                location.reload(true);
            }
        });
    };

    // Display input box to edit common name of ingredient
    $('#ingred-add-btn').on('click', function() {
        addIngredient();
    });

    var addIngredient = function() {
        var btnID = 'ingred-common-name-add-btn'
        var btnText = 'Add Ingredient Common Name'
        var inputID = 'common-name-input'
        var attribute = 'name_common'

        $('#ingred-list-output-2').text('').append(  
            "Enter the ingredient common-name: " +
            "<input id=" + inputID + " type='text'></input> " +
            "<a id='" + btnID + "'" +
               "class='btn btn-primary'" +
               "role='button'>" + btnText +
            "</a>"
        );

        $('#' + inputID).focus();
        nameCommonSave(inputID, btnID, attribute);
    };

    // Accept and save edited common name of ingredient
    var nameCommonSave = function(inputID, btnID, attribute) {
        $('#' + btnID).on('click', function() {
            var nameCommon = $('#' + inputID).val()
            
            $('#ingred-list-output-1').text('').append(
                "____ ____ " + nameCommon
                );

            $('#ingred-list-output-2').text('').append(
                "<h5>New Ingredient:</h5>" +
                "Common name: " + nameCommon + "<br>"
                );

            $('#ingred-list-output-3').text('').append(
                "You have entered the common name; now match " +
                "the ingredient to its entry in the NDB by clicking " +
                "one of the list items to the right/below."
            );

            $.ajax({
                type: 'GET',
                url: '/get_ingred_ndb_json/',
                data: { search: nameCommon },
                error: function() {},
                success: function(data) {
                    $('#right-side-head').text(
                        'Possible Matches in NDB:'
                        );
                    $('#right-side-body').text('');
                    for(i = 0; i < data.length; i++) {
                        $('#right-side-body').append(
                            '<li class="ndb-ingred">' +
                            data[i][0] +
                            ': ' +
                            data[i][1] +
                            '</li>'
                        );
                    }
                }
            });
            numAndDescSave(nameCommon);
        });
    };

    // Add selected item from NDB list to output
    var numAndDescSave = function(nameCommon) {
        $('#right-side-body').on('click', '.ndb-ingred', function() {

            var num_and_desc = $(this).context.innerText
            var num = num_and_desc.split(': ')[0]
            var desc = num_and_desc.split(': ')[1]

            $('#ingred-list-output-2').append(
                "NDB Number: " + num + "<br>" +
                "NDB Description: " + desc + "<br>"
            );
            $('#ingred-list-output-3').text('').append(
                "You have matched the ingredient to the database;" +
                " now choose its form and/or unit of measurement " +
                "by clicking on one of the list items below/right."
            );

            $.ajax({
                type: 'GET',
                url: '/json_ingred_nutr/',
                data: {search2: num },
                error: function() {},
                success: function(data) {
                    $('#right-side-head').text('Forms/Measures in NDB: ');
                    $('#right-side-body').text('');
                    for(i=0; i < data.length; i++) {
                        $('#right-side-body').append(
                            '<li class="nutr-ingred">' +
                            data[i][1] + " [" + data[i][0] + "]" +
                            '</li>'
                        );
                    }
                }
            });
            formOrUnitSave(nameCommon, num, desc)
        });
    };

    // Add selected item from units/forms list to output
    // Possible error at NDB 42267 Babyfood, juice, orange-carrot
    var formOrUnitSave = function(nameCommon, num, desc) {
        $('#right-side-body').on('click', '.nutr-ingred', function() {

            var measures = $(this).context.innerText
            var formOrUnit = measures.split(' [')[0]
            var ndbQuant = measures.split(' [')[1].replace(/]/, '')

            $('#ingred-list-output-1').text(
                "____ " + formOrUnit + " " + nameCommon
                );
            $('#ingred-list-output-2').append(
                "NDB Quantity: " + ndbQuant + "<br>" +
                "Form/Unit: " + formOrUnit + "<br>"
                );
            $('#ingred-list-output-3').text('').append(
                "You have chosen the form/unit; now specify " +
                "the quantity in " + formOrUnit + "(s): <br>" +
                "<input id='quantity-input-box' " +
                       "style='width: 40px;'" +
                       "type='text'></input> " +
                "<a id='quantity-save-btn'" +
                   "class='btn btn-primary'" +
                   "role='button'>Save Quantity" +
                "</a>"
            );
            $('#quantity-input-box').focus();
            quantitySave(nameCommon, num, desc, formOrUnit, ndbQuant)
        });
    };

    // Receive quantity info and save all ingred info to database
    var quantitySave = function(nameCommon, num, desc, formOrUnit, ndbQuant) {
        $('#quantity-save-btn').on('click', function() {

            var qtyCommon = $('#quantity-input-box').val()

            $('#ingred-list-output-1').text(
                qtyCommon + " " + formOrUnit + " " + nameCommon
                );
            $('#ingred-list-output-2').append(
                "qtyCommon: " + qtyCommon + "<br>"
            );
            $('#ingred-list-output-3').text('').append(
                "You have clicked the quantity save button. <br>"
                );

            $.ajax({
                type: 'GET',
                url: '/add_quantity/' + {{ recipe.pk }},
                data: { name_common: nameCommon,
                        ndb_num: num,
                        ndb_desc: desc,
                        ndb_quant: ndbQuant,
                        form_or_unit: formOrUnit,
                        qty_common: qtyCommon
                    },
                error: function() {},
                success: function() {
                    location.reload(true);
                }
            });
        });
    };

    // Display input box to edit name of recipe
    $('#name-edit-btn').on('click', function() {
        $('#name-display').text('').append(
                "<h4>Edit the Recipe Name:</h4>" +
                "<input id='name-append-input-box'" +
                       "type='text'" +
                       "value='{{ recipe.name }}'>" +
                "</input> " +
                "<a id='name-save-btn'" +
                   "class='btn btn-primary'" +
                   "role='button'>Save Changes to Recipe Name" +
                "</a><br>"
            );
        $('#name-append-input-box').focus();
        nameSave();
    });

    // Accept and save edited name of recipe
    var nameSave = function() {
        $('#name-save-btn').on('click', function() {
            $.ajax({
                type: 'GET',
                url: '/recipe_attr_edit_func/' + {{ recipe.pk }},
                data: { attr: 'name',
                        new_value: $('#name-append-input-box').val(),
                       },
                error: function() {},
                success: function() {
                    location.reload(true);
                }
            });
        });
    };

    var servingsScale = function(servTemp) {
        $('#servings-scale-btn').on('click', function() {
            $('#servings-display').text('').append(
                servTemp + " &#8594;" + "&nbsp;&nbsp;" +
                "<input id='servings-input-box'" +
                       "type='text'" +
                       "style='width: 35px;'" +
                       "value='{{ recipe.servings }}'>" +
                "</input>"
            );
            $('#servings-change').text('').append(
                "<a id='servings-save-btn'" +
                   "class='btn btn-primary'" +
                   "role='button'>Save Change" +
                "</a>"
            );
            $('#servings-input-box').focus();
            servingsSave();
        });
    };
    
    // Accept and save edited name of recipe
    var servingsSave = function() {
        $('#servings-save-btn').on('click', function() {
            
            var servModif = Number($('#servings-input-box').val())
            Cookies.set("servModifCookie", servModif);

            $.ajax({
                type: 'GET',
                url: '/recipe_attr_edit_func/' + {{ recipe.pk }},
                data: { attr: 'servings_scaled',
                        new_value: servModif,
                       },
                error: function() {},
                success: function() {
                    location.reload(true);
                }
            });
        });
    };

</script>

{% endblock body %}